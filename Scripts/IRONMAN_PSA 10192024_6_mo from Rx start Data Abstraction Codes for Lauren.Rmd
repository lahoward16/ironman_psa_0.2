---
title: "IRONMAN_Prelim_PSA 6 months 10192024"
author: "Roy Soumyajit"
date: "2024-10-21"
output: html_document
---

```{r setup, include=F, warning=F}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)
library(pacman)
p_load(tidyverse, dynpred, ggplot2, survival, survminer, KMunicate, ggsurvfit, tidycmprsk, lme4, readr, readxl)
library(adjustedCurves)
library(WeightIt)
library(SuperLearner)
library(pbkrtest)
library(mice)
library(haven)
library(table1)
library(naniar)
library(finalfit)
library(tableone)
library(lubridate)
library(ironer)
```


## Methods
*We included patients from PCCTC IRONMAN cohort with available baseline data on treatment regimen and PSA values at baseline, and 1 PSA value after baseline and by month 9.*

*We stratified patients into 3 groups depending on the lowest PSA they had at or before 6 months. These groups included PSA nadir <0.02 ng/mL, 0.02 to 0.2 ng/mL, and >0.2 ng/mL, respectively.*

*A landmark population was constructed with patients who were alive and under follow-up for more than 12 months.*

*We determined 3-year OS rates for the three PSA nadir groups. Subsequently we applied Cox proportional hazard regression model to determine the adjusted association of PSA nadir with OS. We used two models - one with time to PSA nadir and one without time to PSA nadir*


*We applied competing risk methods described by Fine and Gray to determine the cumulative incidence of prostate cancer specific mortality (PCSM) in these three PSA nadir groups. Deaths from causes other than prostate cancer were considered as competing events. Again we applied multivariable CRR with and without time to PSA nadir.*


# Data analysis and Cleaning {.tabset}

## Import data and merge

```{r data}

# load("~/Documents/IRONMAN/2024-09-23_ironman.RData")
load("V:/IRONMAN/2024-11-04/2024-11-04_ironman.Rdata")

###########################################################
cohort <- medidata$cohort%>%
  filter(cohort=="mHSPC")%>%
  select(subject, cohort, denovomet_disease)%>%
  distinct(subject, .keep_all = T)

```


## Assigning first line treatment
```{r data treatment, echo=T}

### Treatment preparation
treatment_prep <- 
  medidata$ca_cm_derived %>% 
  dplyr::select(
    subject, treatment, exstdat_int, exendat_int, 
    treatment_recode = trt_treatment_recode, treatment_category = trt_treatment_category)

treatment_prep <- treatment_prep%>%
  filter(subject %in% cohort$subject)

treatment_prep <- treatment_prep%>%
  filter(!is.na(exstdat_int)) %>% 
  # remove treatments not counted as a line of therapy
  filter(!treatment_category %in% c("Steroid", "Bone-Modifying Agent", "Bisphosphonates", "Antidiabetic"))%>%
  # keep relevant fields
  select(subject, exstdat_int, exendat_int, treatment_category, treatment_recode)


##### Collecting consent date and matching with the mHSPC cohort
consent <- medidata$ic%>%select(subject, cnstdate_int)
consent <- consent%>%
  filter(subject %in% cohort$subject)

#### To calculate gap from consent to start of treatment

treatment_prep <- left_join(treatment_prep, consent, by = "subject")

treatment_prep <- treatment_prep%>%
  mutate(gap = as.duration(cnstdate_int%--%exstdat_int)/ddays(1))%>%
  filter(gap>=(-90))

#### Next step
treatment_lot <- treatment_prep %>%
  # sort by subject and treatment start date
  arrange(subject, exstdat_int) %>%
  # within each subject, assign line of therapy
  group_by(subject) %>%
  group_modify(~ ironer::assign_lot(
    .data = .x, 
    # note, you could use treatment_category here as well to get a high level
    # view of line of therapy by category
    treatment = treatment_category,
    dt_trt_observed = exstdat_int, 
    dt_treatment_end = exendat_int
  ))%>%
  ungroup()  

```

## Selecting Patients who Received ARPI
```{r}

############################### First lot ARPI
first_lot <- treatment_lot%>%
  filter(lot==1)
  

first_arpi <- first_lot%>%
  filter(str_detect(treatment_category,"AR Signaling Inhibitor"))%>%
  distinct(subject, .keep_all = T)


first_arpi <- first_arpi%>%
  select(subject,regimen,treatment_category,treatment_recode)

################################ Second lot ARPI

second_lot <- treatment_lot%>%
  filter(lot==2)

### First select who received ADT in first lot
first_adt <- first_lot%>%
  filter(treatment_category=="ADT" & treatment_recode != "Bicalutamide")%>%
  distinct(subject, .keep_all = T)%>%
  rename(first_treatment_category = treatment_category, 
         first_dt_lot_start = dt_lot_start,
         first_dt_lot_last_obs = dt_lot_last_obs)%>%
  select(subject,first_treatment_category,first_dt_lot_start,first_dt_lot_last_obs)

### Merging second lot patients to who received ADT in first lot
second_lot <- merge(second_lot, first_adt, by = "subject")

### Now out of this merged cohort choose those who received ARPI within 90 days
second_arpi <- second_lot%>%
  filter(str_detect(treatment_category,"AR Signaling Inhibitor"))%>%
  distinct(subject, .keep_all = T)%>%
  #### Calculating gap
  mutate(gap_second = as.duration(first_dt_lot_start%--%exstdat_int)/ddays(1))%>%
  #### Selecting patients with <90 days gap
  filter(gap_second<=90)

#### Excluding wrongly coded ARPI regimens
second_arpi <- second_arpi%>%
  filter(regimen%in% c("ADT, AR Signaling Inhibitor","ADT, AR Signaling Inhibitor, Chemotherapy","AR Signaling Inhibitor","AR Signaling Inhibitor, NA","AR Signaling Inhibitor, Chemotherapy"))%>%
  rename(second_dt_lot_start = dt_lot_start,
         second_dt_lot_last_obs = dt_lot_last_obs,
         second_regimen = regimen,
         second_treatment_category = treatment_category)

### Renaming columns
second_arpi <- second_arpi%>%
  select(subject,second_regimen,second_treatment_category,treatment_recode)%>%
  rename(treatment_category = second_treatment_category,
         regimen = second_regimen)

########################### Third ARPI

third_lot <- treatment_lot%>%
  filter(lot==3)
### First select who received ADT in first lot
third_lot <- merge(third_lot, first_adt, by = "subject")

### Now out of this merged cohort choose those who received ARPI within 90 days
third_arpi <- third_lot%>%
  filter(str_detect(treatment_category,"AR Signaling Inhibitor"))%>%
  distinct(subject, .keep_all = T)%>%
  mutate(gap_third = as.duration(first_dt_lot_start%--%exstdat_int)/ddays(1))%>%
  filter(gap_third<=90)

### Selecting necessary columns
third_arpi <- third_arpi%>%
  select(subject, regimen, treatment_category, treatment_recode)


### Adding all these to create the cohort of patients who received ARPI
ARPI = dplyr::bind_rows(first_arpi,second_arpi,third_arpi)%>%
  distinct(subject, .keep_all = T)%>%
  mutate(ARPI=1)

```

## Merging date of treatment initiation with the ARPI intensified group
```{r}

### For each patient we selected the earliest date of treatment start (which could be ADT as well) - the reason is even simple ADT can cause PSA to drop

treatment_start_date <- treatment_lot%>%
  group_by(subject)%>%
  slice_min(order_by = dt_lot_start)%>%
  select(subject, dt_lot_start)%>%
  ungroup()%>%
  distinct(subject, .keep_all = T)

ARPI <- left_join(ARPI, treatment_start_date, by = "subject")
```

## Selecting patients with docetaxel
```{r}
### First lot Chemo
first_chemo <- first_lot%>%
  filter(str_detect(treatment_category,"Chemotherapy"))%>%
  distinct(subject, .keep_all = T)


first_chemo <- first_chemo%>%
  select(subject,regimen,treatment_category,treatment_recode)

### Second lot Chemo

second_chemo <- second_lot%>%
  filter(str_detect(treatment_category,"Chemotherapy"))%>%
  distinct(subject, .keep_all = T)%>%
  mutate(gap_second = as.duration(first_dt_lot_start%--%exstdat_int)/ddays(1))%>%
  filter(gap_second<=90)


second_chemo <- second_chemo%>%
  filter(treatment_recode=="Docetaxel")%>%
  rename(second_dt_lot_start = dt_lot_start,
         second_dt_lot_last_obs = dt_lot_last_obs,
         second_regimen = regimen,
         second_treatment_category = treatment_category)


second_chemo <- second_chemo%>%
  select(subject,second_regimen,second_treatment_category,treatment_recode)%>%
  rename(treatment_category = second_treatment_category,
         regimen = second_regimen)

### Third lot Chemo

third_chemo <- third_lot%>%
  filter(str_detect(treatment_category,"Chemotherapy"))%>%
  distinct(subject, .keep_all = T)%>%
  mutate(gap_third = as.duration(first_dt_lot_start%--%exstdat_int)/ddays(1))%>%
  filter(gap_third<=90)

third_chemo <- third_chemo%>%
  select(subject, regimen, treatment_category, treatment_recode)

#### Combining those who received chemo in first, second, or third lot
Chemotherapy <- dplyr::bind_rows(first_chemo,second_chemo,third_chemo)%>%
  distinct(subject, .keep_all = T)%>%
  mutate(Docetaxel=1)
```

## Treatment final coding
```{r}

### Selecting the Subject ID, ARPI, Date of treatment start from ARPI cohort
ARPI <- ARPI%>%
  select(subject, ARPI, dt_lot_start)

### Selecting subject ID from the chemotherapy cohort
Chemotherapy <- Chemotherapy%>%
  select(subject,Docetaxel)

### We will club the ARPI and Docetaxel info with the original cohort
cohort <- left_join(cohort,ARPI, by = "subject")
cohort <- left_join(cohort, Chemotherapy, by = "subject")
cohort$ADT = 1
cohort <- cohort%>%
  replace_na(list(Docetaxel=0, ARPI=0))

###################################################################################
### Treatment recoding to ADT, ADT+Doce, ADT + ARPI, Triplet
cohort$treatment = NA
cohort$treatment[cohort$ARPI==0 & cohort$Docetaxel==0] = "ADT alone"
cohort$treatment[cohort$ARPI==1 & cohort$Docetaxel==0] = "ADT+ARPI"
cohort$treatment[cohort$ARPI==0 & cohort$Docetaxel==1] = "ADT+Docetaxel"
cohort$treatment[cohort$ARPI==1 & cohort$Docetaxel==1] = "Triplet"

#### Selecting patients who received ARPI with ADT or as part of triplet
cohort1 <- cohort%>%
  filter(treatment %in% c("Triplet","ADT+ARPI"))
```

## Merging with baseline data
```{r}
########## Derived Baseline Characteristics
cohort2 <- medidata$subject%>%
  select(subject, is_metastatic_baseline, gleason_bx_mh, gleason_rp_prpros,gleason_bx_prmi,gleason_rp_prmi,gleason_rp_derived,gleason_combined_derived,gleason_factor,origin_metastatic_baseline)

##### Date of consent
consent <- medidata$ic%>%select(subject, cnstdate_int) 

#### adding consent date to the cohort with baseline characteristics
cohort2 <- left_join(cohort2, consent)

####### Merging treatment data (cohort1) with baseline characteristics data
cohort2 <- merge(cohort2, cohort1, by = "subject")

###### Checking for missing data
cohort2%>%
  miss_var_summary()


#### Recoding some of the baseline characteristics data
cohort2 <- cohort2%>%
  mutate(Gleason.total = ifelse(gleason_factor %in% c("0","<=6","7"),"6-7",
                                ifelse(gleason_factor %in% c("8","9","10"),"8-10","Not reported")),
         Liver_mets = ifelse(str_detect(origin_metastatic_baseline,"liver"), "Yes","No"),
         Lung_mets = ifelse(str_detect(origin_metastatic_baseline,"lung"), "Yes","No"),
         Bone_mets = ifelse(str_detect(origin_metastatic_baseline,"thor|spine|Bone|skull|ext|pelvis"),"Yes","No"),
         distal_nodes = ifelse(str_detect(origin_metastatic_baseline,"dn"),"Yes","No"))%>%
  rename(denovomets_yes = is_metastatic_baseline)
```

## Baseline characteristics merge
```{r}
alk <- medidata$alk
alk$alkval <- gsub("<", "", as.character(alk$alkval))
alk$alkval <- gsub(">", "", as.character(alk$alkval))

dt_lot_start <- cohort2%>%
  select(subject, dt_lot_start, cnstdate_int)

alk <- left_join(alk, dt_lot_start, by = "subject")%>%
  mutate(alk_gap = as.duration(cnstdate_int%--%alkdt_int)/ddays(1))%>%
  filter(alk_gap>=-90 & alk_gap<30)%>%
  select(subject,alkval,hxalkunit,alkdt_int)%>%
  distinct(subject, .keep_all = T)%>%
  mutate(alkval = as.numeric(alkval))%>%
  rename(baseline_alkval = alkval,
         baseline_alkdt = alkdt_int)

alk <- alk%>%
  mutate(baseline_alkval = ifelse(hxalkunit=="uKat/L", baseline_alkval*60, baseline_alkval))%>%
  select(-hxalkunit)

## Joining with baseline PSA
cohort2 <- left_join(cohort2, alk, by = "subject")

cohort2$alkcat <- ifelse(cohort2$baseline_alkval<=150,"150 or less",">150")

############ Age at diagnosis
age <- medidata$dm%>%
  select(subject, age)%>%
  mutate(age = as.numeric(age))

## Joining with baseline PSA
cohort2 <- left_join(cohort2, age, by = "subject")


############ Site of diagnosis ################################
cs <- medidata$cs

cs <- left_join(cs, dt_lot_start)%>%
  mutate(cs_gap = as.duration(cnstdate_int%--%csdat_int)/ddays(1))%>%
  filter(cs_gap>=-90 & cs_gap<30)%>%
  select(subject, csskull, csspine, csliver, cslung, csext, cspelvis, csdn)%>%
  distinct(subject, .keep_all = T)

## Joining with baseline PSA
cohort2 <- left_join(cohort2, cs, by = "subject")


## Radiation data merge
rt = medidata$ptradiation

rt = rt%>%
  select(subject, radreg, radregt, radregtarget, radtdose, radregdt)%>%
  filter(radregt =="Definitive"|radregt=="Salvage")%>%
  filter(str_detect(radregtarget,"Prostate|pelvis"))%>%
  distinct(subject, .keep_all = T)%>%
  mutate(Radiation = 1)

cohort2 <- left_join(cohort2, rt, by = "subject")

```


## Merging Race data
```{r}
Race <- medidata$subject%>%
  select(subject, race_26_1, race_26_2, race_26_3, race_26_4, race_26_5, race_26_6, race_26_7, race_26_other)


Race$Race <- apply(Race[, c('race_26_1', 'race_26_2', 'race_26_3', 'race_26_4', 
                        'race_26_5', 'race_26_6', 'race_26_7', 'race_26_other')], 
                 1, function(x) {
  # Count non-NA values
  non_na_values <- x[!is.na(x)]
  
  # If more than one race is present, assign "Multicategory"
  if (length(non_na_values) > 1) {
    return("Multicategory")
  } else if (length(non_na_values) == 1) {
    return(non_na_values)
  } else {
    return(NA)
  }
})

Race <- Race%>%
  replace_na(list(Race = "Not reported"))

cohort2 <- left_join(cohort2, Race%>%select(subject,Race), by = "subject")
```

## Merging baseline PSA
```{r}
psa <- medidata$psa
psa$psa <- gsub("<", "", as.character(psa$psa))
psa$psa <- gsub(">", "", as.character(psa$psa ))

dt_lot_start <- cohort2%>%
  select(subject, dt_lot_start, cnstdate_int)

baseline_psa <- left_join(psa, dt_lot_start, by = "subject")%>%
  mutate(psa_gap = as.duration(cnstdate_int%--%psadt_int)/ddays(1))%>%
  filter(psa_gap<=30 & psa_gap>=(-90))%>%
  select(subject,psa,psadt_int)%>%
  distinct(subject, .keep_all = T)%>%
  mutate(psa = as.numeric(psa))%>%
  rename(baseline_psa = psa,
         baseline_psadt = psadt_int) %>% 
  mutate(baseline_psa_cat = ifelse(baseline_psa<=20,"<=20",">20"))


cohort2 <- left_join(cohort2, baseline_psa, by = "subject")%>%
  mutate(baseline_psa_cat = ifelse(baseline_psa<=20,"<=20",">20"))

cohort2 <- cohort2%>%
  replace_na(list(baseline_psa_cat="Unknown"))
```

## PSA nadir selection up to 6 months 
```{r}
psa <- medidata$psa
psa$psa <- gsub("<", "", as.character(psa$psa)) ## Stripping off < and > characters
psa$psa <- gsub(">", "", as.character(psa$psa)) ## Stripping off < and > characters

psa_for_merge <- psa%>%
  mutate(psa = as.numeric(psa)) ##Converting to numeric values

psa_for_merge <- psa_for_merge%>%
  select(subject, psa, psadt_int, instance_name,psadt_mm) ## Selecting necessary columns

psa_for_merge <- psa_for_merge%>%
  filter(subject %in% cohort2$subject) ## Selecting patients that had baseline PSA and other necessary information

### Calculating time of PSA assessment since consent
psa_for_merge <- left_join(psa_for_merge, cohort2%>%select(subject, cnstdate_int, dt_lot_start), by = "subject")%>%
  mutate(PSA_gap = as.duration(cnstdate_int%--%psadt_int)/dmonths(1),
         PSA_trt_gap = as.duration(dt_lot_start%--%psadt_int)/dmonths(1))

#############################
psa_for_merge6 <- psa_for_merge%>%
  mutate(PSA_trt_gap = ifelse(is.na(PSA_trt_gap),PSA_gap, PSA_trt_gap))%>% ### Replace NA values in PSA gap by PSA_treatment gap
  filter(PSA_trt_gap<=6 & PSA_trt_gap>0)%>% ### Selecting the PSA measuments within 6 months of enrolment and also making sure that this was after treatment initiation
  group_by(subject)%>%
  slice_min(order_by = psa)%>% ### Choosing the lowest PSA by those measurements within 6 months
  ungroup()

psa_for_merge6 <- psa_for_merge6%>%
  mutate(PSA_Nadir6 = ifelse(psa<0.02,"<0.02",
                            ifelse(psa>=0.02 & psa<=0.2, "0.02-0.2",">0.2"))) ### Categorizing the lowest PSA value

psa_for_merge6 <- psa_for_merge6%>%
  group_by(subject)%>%
  slice_min(order_by = PSA_trt_gap) ### Choosing the lowest time to nadir for each subject


psa_for_merge6 <- psa_for_merge6%>%
  select(subject, psa, PSA_Nadir6, PSA_gap, PSA_trt_gap)%>%
  rename(Nadir_value6 = psa,
         PSA_gap6 = PSA_gap,
         PSA_trt_gap6 = PSA_trt_gap)%>%
  filter(!duplicated(subject))

psa_for_merge6 <- psa_for_merge6%>%
  drop_na(Nadir_value6) 

cohort2 <- inner_join(cohort2, psa_for_merge6, by = "subject")%>%
  mutate(PSA_Nadir6 = factor(PSA_Nadir6, levels =c("<0.02","0.02-0.2",">0.2")))
```

## PSA nadir selection up to 12 months
```{r}
psa <- medidata$psa
psa$psa <- gsub("<", "", as.character(psa$psa)) ## Stripping off < and > characters
psa$psa <- gsub(">", "", as.character(psa$psa)) ## Stripping off < and > characters

psa_for_merge <- psa%>%
  mutate(psa = as.numeric(psa)) ##Converting to numeric values

psa_for_merge <- psa_for_merge%>%
  select(subject, psa, psadt_int, instance_name,psadt_mm) ## Selecting necessary columns

psa_for_merge <- psa_for_merge%>%
  filter(subject %in% cohort2$subject) ## Selecting patients that had baseline PSA and other necessary information

### Calculating time of PSA assessment since consent
## Calculating time of PSA assessment since consent
psa_for_merge <- left_join(psa_for_merge, cohort2%>%select(subject, cnstdate_int, dt_lot_start), by = "subject")%>%
  mutate(PSA_gap = as.duration(cnstdate_int%--%psadt_int)/dmonths(1),
         PSA_trt_gap = as.duration(dt_lot_start%--%psadt_int)/dmonths(1))

#############################
psa_for_merge12 <- psa_for_merge%>%
  mutate(PSA_trt_gap = ifelse(is.na(PSA_trt_gap),PSA_gap, PSA_trt_gap))%>% ### Replace NA values in PSA gap by PSA_treatment gap
  filter(PSA_trt_gap>0 & PSA_trt_gap<=12)%>% ### Selecting the PSA measuments within 12 months of enrolment and also making sure that this was after treatment initiation
  group_by(subject)%>%
  slice_min(order_by = psa)%>% ### Choosing the lowest PSA by those measurements within 12 months
  ungroup()

psa_for_merge12 <- psa_for_merge12%>%
  mutate(PSA_Nadir12 = ifelse(psa<0.02,"<0.02",
                            ifelse(psa>=0.02 & psa<=0.2, "0.02-0.2",">0.2"))) ### Categorizing the lowest PSA value

psa_for_merge12 <- psa_for_merge12%>%
  group_by(subject)%>%
  slice_min(order_by = PSA_trt_gap) ### Choosing the lowest time to nadir for each subject


psa_for_merge12 <- psa_for_merge12%>%
  select(subject, psa, PSA_Nadir12, PSA_gap, PSA_trt_gap)%>%
  rename(Nadir_value12 = psa,
         PSA_gap12 = PSA_gap,
         PSA_trt_gap12 = PSA_trt_gap)%>%
  filter(!duplicated(subject))

psa_for_merge12 <- psa_for_merge12%>%
  drop_na(Nadir_value12) 

cohort2 <- inner_join(cohort2, psa_for_merge12, by = "subject")%>%
  mutate(PSA_Nadir12 = factor(PSA_Nadir12, levels =c("<0.02","0.02-0.2",">0.2")))
```

## Modifying columns in baseline data
```{r}
cohort2 <- cohort2%>%
  mutate_at(vars(csliver, cslung, csdn, cspelvis, csext, csspine, csskull, denovomet_disease,alkcat), ~replace(., is.na(.), "Unknown"))


cohort2 <- cohort2 %>%
  mutate_at(vars(csliver, cslung, csdn, cspelvis, csspine, csskull, denovomet_disease), 
            ~ factor(case_when(
              . == "Yes" ~ "Yes",
              . == "No" ~ "No",
              TRUE ~ "Unknown",  # Handle NA as "unknown"
              TRUE ~ as.character(.)), # Catch other cases
              levels = c("Yes", "No", "Unknown")))
```

## Adding vital status
```{r}
pstatus <- medidata$pstatus%>%
  select(subject, cod, deathdate)%>%
  mutate(Dead=1)

cohort2 <- left_join(cohort2, pstatus, by = "subject")%>%
  replace_na(list(Dead=0))
```


## Merging follow-up data
*In 3 cases cause of death was missing. We considered them to die of non-cancer related causes.*
```{r}

### Getting dates from cycles
dates <- medidata$cyc_date


#### Baseline visit date
baseline <- dates%>%
  filter(instance_name=="Baseline 0")%>%
  dplyr::select(subject, visit_date)%>%
  rename(date_baseline = visit_date)

### Selecting the earliest date for each subject
baseline <- baseline%>%
  group_by(subject)%>%
  slice_min(order_by = date_baseline)

baseline <- baseline%>%
  distinct(subject, .keep_all = TRUE)


### Last follow-up date
follow_up <- dates%>%
  group_by(subject)%>%
  slice_max(order_by = visit_date)%>%
  dplyr::select(subject, visit_date)%>%
  rename(date_lfu = visit_date)

follow_up <- follow_up%>%
  distinct(subject, .keep_all = T)

follow_up <- merge(baseline, follow_up, by = "subject")

cohort2 <- merge(cohort2, follow_up, by = "subject")

## Calculating OS from treatment start date
cohort2.1 <- cohort2%>%
  mutate(OS_date = pmin(date_lfu, deathdate, na.rm = T),
         OS = as.duration(dt_lot_start%--%OS_date)/dmonths(1),
         PCSM = as.factor(ifelse(Dead==0,"Alive",
                       ifelse(Dead==1 & cod=="Prostate Cancer", "PCSM", "OCM"))))

cohort2.1 <- cohort2.1%>%
  replace_na(list(PCSM="OCM")) 
### In 3 cases cause of death was missing. We considered them to die of non-cancer related causes.
###############Univariable Cox regression ##################################################
explan <- c("age","baseline_psa","baseline_psa_cat","alkcat","csliver","cslung","csdn","csskull","csspine","denovomet_disease","treatment","Gleason.total")

cohort2.1%>%
  coxphuni(
    dependent = "Surv(OS,Dead)",
    explanatory = explan
  )%>%
  fit2df()


### Factors associated with OS were age, baseline PSA, baseline ALP, Skull involvement, Gleason score, de novo metastatic presentation, and modest association with lung involvement. 

### Factors associated with PSA nadir were age, baseline PSA, baseline ALP, skull involvement, spine involvement, Gleason score, De novo metastatic disease at presentation. 

### Final factors are ge, baseline PSA, baseline ALP, skull involvement, Gleason score, De novo metastatic disease at presentation
```

## Progression details
```{r}

#### Using newpq version 4
prog0 <- medidata$newdisc_pqv4%>%
  select(subject, instance_name, newpq2_v4, newpq3_v4, newpq4_v4, newpq5_v4, newpq6_v4)%>%
  filter(newpq3_v4=="Yes"|newpq4_v4=="Yes"|newpq5_v4=="Yes"|newpq6_v4=="Yes")%>%
  distinct(subject, .keep_all = T)%>%
  select(subject, instance_name)%>%
  mutate(any_progression = 1)%>%
  mutate(time = gsub("Month", "", instance_name) %>% trimws())%>%
  mutate(time = as.numeric(time))
  
#### Using disc_pq
prog1 <- medidata$disc_pq%>%
  filter(prim_reason=="Disease Progression (Go to C2)")%>%
  select(subject,instance_name,c2_psa1, c2_psa2, c3_psa3,c2_rp1, c2_rp2, c2_rp3,c2_rp4,c2_rp5)%>%
  distinct(subject, .keep_all = T)%>%
  select(subject, instance_name)%>%
  mutate(any_progression = 1)%>%
  mutate(time = gsub("Month", "", instance_name) %>% trimws())%>%
  mutate(time = as.numeric(time))
  
### using new disc_pq version 5
prog2 <- medidata$newdisc_pqv5%>%
  select(subject, instance_name, newpq3_v5, newpq4_v5, newpq5_v5, newpq6_v5)%>%
  mutate(time = gsub("Month", "", instance_name) %>% trimws())%>%
  filter(newpq3_v5=="Yes"|newpq4_v5=="Yes"|newpq6_v5=="Yes"|newpq5_v5=="Yes")%>%
  select(subject, instance_name, time)%>%
  mutate(time = as.numeric(time))%>%
  mutate(any_progression = 1)%>%
  replace_na(list(time=0))


### combining all three and selecting earliest date of progression
prog <- bind_rows(prog0, prog1, prog2)%>%
  group_by(subject)%>%
  slice_min(order_by = time)

#######################################################
dates <- medidata$cyc_date%>%
  select(subject, instance_name, visit_date)

prog <- merge(prog, dates, by = c("subject","instance_name"))%>%
  rename(prog_instance = instance_name,
         prog_time = time, 
         prog_date = visit_date)

cohort2.1 <- left_join(cohort2.1, prog, by = "subject")

cohort2.1 <- cohort2.1%>%
  replace_na(list(any_progression=0))%>%
  mutate(prog_date = pmin(prog_date, OS_date, na.rm = T),
         PFS = as.duration(dt_lot_start%--%prog_date)/dmonths(1),
         cum_prog = ifelse(any_progression==0 & Dead==0,"censored",
                           ifelse(any_progression==1 & PFS<=OS,"progression","competing")),
         progression = ifelse(any_progression==1|Dead==1,1,0))

cohort2.1 <- cohort2.1%>%
  mutate(cum_prog = factor(cum_prog, levels = c("censored","progression","competing")),
         PFS = ifelse(PFS<0,OS,PFS))

######################## Univariable association of progression with baseline factors #########
explan <- c("age","baseline_psa","baseline_psa_cat","alkcat","csliver","cslung","csdn","csskull","csspine","denovomet_disease","treatment","Gleason.total")

cohort2.1%>%
  coxphuni(
    dependent = "Surv(PFS,progression)",
    explanatory = explan
  )%>%
  fit2df() 
### Factors associated with PFS were age, baseline PSA, baseline ALP, Skull involvement, spine involvement, Gleason score, modest association with de novo metastatic presentation. 

### Factors associated with PSA nadir were age, baseline PSA, baseline ALP, skull involvement, spine involvement, Gleason score, De novo metastatic disease at presentation. 

### final factors are ge, baseline PSA, baseline ALP, skull involvement, Gleason score, De novo metastatic disease at presentation, spine involvement

```

## Calculating OS and multivariable regression
```{r}
dta_baseline <- cohort2.1%>%
  filter(OS>12)%>%
  mutate(OS = OS-12)

### Number of deaths
table(dta_baseline$Dead)

### Number of patients who died with progression
dta_baseline%>%select(Dead, any_progression)%>%table()

### Number of patients with PCSM after progression
dta_baseline%>%select(PCSM, any_progression)%>%table()

####################################################################################
### Simple survival analysis
survival_nadir <- survfit(Surv(OS,Dead==1)~PSA_Nadir12, data = dta_baseline)
### Survival at 3 years
summary(survival_nadir, times = 36)

### Logrank test (overall and pairwise comparisons)
survdiff(Surv(OS,Dead==1)~PSA_Nadir12, data = dta_baseline, )

pairwise_survdiff(Surv(OS,Dead==1)~PSA_Nadir12, data = dta_baseline, p.adjust.method = "bonferroni")

### Survival curves by PSA nadir
survfit2(Surv(OS,Dead==1)~PSA_Nadir12, data = dta_baseline)%>%
  ggsurvfit(linetype_aes = T, linewidth = 1) + 
  add_censor_mark() + 
  add_confidence_interval() + 
  add_risktable() + 
  scale_ggsurvfit(x_scales = list(breaks = seq(0,48, by = 12)), y_scales = list(breaks = seq(0,1, by = 0.2))) + labs(x = "Time since landmark timepoint (in months)", y = "Overall survival probability") + 
  theme_bw()

###############################################################################
### Multivariable Cox regression
### The real covariables which had association with OS and PSA nadir were age, baseline psa category, alkphos category, csskull, denovo mets diease, and Gleason score. 
cox_os <- coxph(Surv(OS,Dead==1)~PSA_Nadir12 + csskull + Gleason.total + denovomet_disease + age + alkcat, data = dta_baseline, x = T, y = T)
summary(cox_os)

cox.zph(cox_os) ## There was some violation of proportionality assumption

###################################################################################
# Is the association linear between time interval to PSA nadir and OS?

library(splines)
coxph(Surv(OS,Dead==1)~ns(PSA_trt_gap12,4), data = dta_baseline)%>%termplot(., rug = T,  xlabs = "Time interval to PSA nadir", ylabs = "Partial hazard ratio for OS", se = T)

################ Now the same model with time interval to PSA nadir fitted with natural spline in patients with baseline PSA available
library(splines)

# Fit the Cox model with natural splines with 4 degrees of Freedom for PSA_gap
cox_os1_spline <- coxph(Surv(OS, Dead == 1) ~ PSA_Nadir12 + ns(PSA_trt_gap12, df = 4) + csskull + Gleason.total + denovomet_disease + age + alkcat, data = dta_baseline, x = TRUE, y = TRUE)

# Get the summary of the model
summary(cox_os1_spline)

termplot(cox_os1_spline, terms = 2, se = TRUE, rug = TRUE, xlabs = "Time interval to PSA nadir", ylabs = "Partial hazard ratio for OS") ###Slight non-linearity. I would go with the prior model for easier interpretability. 

cox_os1_linear <- coxph(Surv(OS, Dead == 1) ~ PSA_Nadir12 + PSA_trt_gap12 + csskull + Gleason.total + denovomet_disease + age + alkcat, data = dta_baseline, x = TRUE, y = TRUE)

# Get the summary of the model
summary(cox_os1_linear)

cox.zph(cox_os1_linear)

######################################################################
########### With categorical time interval to PSA nadir value
dta_baseline <- dta_baseline%>%
  mutate(PSA_gap1 = ifelse(PSA_trt_gap12<=3,"<=3",
                           ifelse(PSA_trt_gap12>3 & PSA_trt_gap12<=6,">3-6",">6")))

cox_os2 <- coxph(Surv(OS, Dead == 1) ~ PSA_Nadir12 + PSA_gap1 + csskull + Gleason.total + denovomet_disease + age + alkcat, 
                        data = dta_baseline, x = TRUE, y = TRUE)

# Get the summary of the model
summary(cox_os2)

cox.zph(cox_os2)

####################################################################################
### To account for violation of proportionality assumption in the model without time to PSA nadir #############
# Load necessary library
# Define the formula
surv_formula <- Surv(OS, Dead == 1) ~ PSA_Nadir12 + csskull + Gleason.total + denovomet_disease + age + alkcat

# List of distributions to test
dist_list <- c("weibull", "lognormal", "loglogistic", "exponential", "gompertz")

# Initialize an empty list to store the results
model_list <- list()
aic_list <- numeric(length(dist_list))

# Loop through each distribution and fit the survival model
for (i in seq_along(dist_list)) {
  dist <- dist_list[i]
  if (dist == "gompertz") {
    # Gompertz is not directly available in survreg, so use flexsurv
    model <- flexsurv::flexsurvreg(surv_formula, data = dta_baseline, dist = "gompertz")
    aic_value <- model$AIC
  } else {
    # Fit the model using survreg for other distributions
    model <- survreg(surv_formula, data = dta_baseline, dist = dist)
    aic_value <- AIC(model)
  }
  
  # Store model and AIC
  model_list[[dist]] <- model
  aic_list[i] <- aic_value
}

# Create a data frame with AIC values for comparison
aic_results <- data.frame(
  Distribution = dist_list,
  AIC = aic_list
)

# Find the best distribution based on the lowest AIC
best_model_index <- which.min(aic_results$AIC)
best_model <- model_list[[dist_list[best_model_index]]]

# Print AIC results and best model
print(aic_results)

cat("Best model distribution:", dist_list[best_model_index], "\n")

summary(best_model)

```

## Cancer specific deaths
```{r}
dta_baseline$PCSM = factor(dta_baseline$PCSM, levels = c("Alive","PCSM","OCM"))
table(dta_baseline$PCSM)

dta_baseline%>%
  group_by(PSA_Nadir12)%>%
  select(PCSM)%>%table()

dta_baseline%>%
  group_by(PSA_Nadir12)%>%
  select(PCSM)%>%table()%>%prop.table(margin = 1)

##########################################################################################
tidycmprsk::cuminc(Surv(OS,PCSM)~PSA_Nadir12, data = dta_baseline)%>%
  tidycmprsk::tbl_cuminc(times = c(24,36, 48), label_header = "**Month {time}**")%>%
  add_p()%>%
  add_n()

cuminc(Surv(OS, PCSM) ~ PSA_Nadir12, data = dta_baseline) %>%
  ggcuminc(outcome = "PCSM") +
  add_confidence_interval() +
  add_risktable() +
  scale_x_continuous(limits = c(0,48), breaks = c(0,12,24,36,48)) + 
  scale_y_continuous(limits = c(0,1), n.breaks = 5) + 
  labs(x = "Time since landmark timepoint (months)", y = "Cumulative incidence of CSM")

#########33Competing risk regression with just PSA nadir level 
tidycmprsk::crr(Surv(OS,PCSM)~PSA_Nadir12 + csskull + Gleason.total + denovomet_disease + age + alkcat, data = dta_baseline, failcode = "PCSM")

######################## Competing risk regression with PSA nadir level and time to PSA nadir with natural splines and 4 degrees of freedom
tidycmprsk::crr(Surv(OS,PCSM)~PSA_Nadir12 + ns(PSA_trt_gap12, 4) + csskull + Gleason.total + alkcat + denovomet_disease + age, data = dta_baseline, failcode = "PCSM")

tidycmprsk::crr(Surv(OS,PCSM)~PSA_Nadir12 + PSA_trt_gap12 + csskull + Gleason.total + alkcat + denovomet_disease + age, data = dta_baseline, failcode = "PCSM")

###With categorical time to PSA nadir interval

tidycmprsk::crr(Surv(OS,PCSM)~PSA_Nadir12 + PSA_gap1 + csskull + Gleason.total + alkcat + denovomet_disease + age, data = dta_baseline, failcode = "PCSM")

```

## Cumulative incidence of progression
```{r}
dta_baseline_pfs <- cohort2.1%>%
  filter(PFS>12)%>%
  mutate(PFS = PFS-12) 

dta_baseline_pfs <- dta_baseline_pfs%>%
  mutate(PSA_gap1 = ifelse(PSA_trt_gap12<=3,"<=3",
                           ifelse(PSA_trt_gap12>3 & PSA_trt_gap12<=6,">3-6",">6")))

dta_baseline_pfs%>%
  group_by(PSA_Nadir12)%>%
  select(cum_prog)%>%table()

dta_baseline_pfs%>%
  group_by(PSA_Nadir12)%>%
  select(cum_prog)%>%table()%>%prop.table(margin = 1)

######################################################################################3
dta_baseline_pfs%>%
  group_by(PSA_Nadir12)%>%
  select(any_progression)%>%
  table()

dta_baseline_pfs%>%
  group_by(PSA_Nadir12)%>%
  select(any_progression)%>%
  table()%>%
  prop.table(margin = 1)

#################################################################################################
tidycmprsk::cuminc(Surv(PFS,cum_prog)~PSA_Nadir12, data = dta_baseline_pfs)%>%
  tidycmprsk::tbl_cuminc(times = c(24,36, 48), label_header = "**Month {time}**")%>%
  add_p()%>%
  add_n()

cuminc(Surv(PFS,cum_prog) ~ PSA_Nadir12, data = dta_baseline_pfs) %>%
  ggcuminc(outcome = "progression") +
  add_confidence_interval() +
  add_risktable() +
  scale_x_continuous(limits = c(0,48), breaks = c(0,12,24,36,48)) + 
  scale_y_continuous(limits = c(0,1), n.breaks = 5) + 
  labs(x = "Time since landmark timepoint (months)", y = "Cumulative incidence of progression")

#########33Competing risk regression with just PSA nadir level 
tidycmprsk::crr(Surv(PFS,cum_prog)~PSA_Nadir12 + csskull + csspine + Gleason.total + denovomet_disease + age + alkcat, data = dta_baseline_pfs, failcode = "progression")

######################## Competing risk regression with PSA nadir level and time to PSA nadir with natural splines and 4 degrees of freedom in patients with baseline PSA data

tidycmprsk::crr(Surv(PFS,cum_prog)~PSA_Nadir12 + ns(PSA_trt_gap12, 4) + csskull + csspine + Gleason.total + denovomet_disease + age + alkcat, data = dta_baseline_pfs, failcode = "progression")

### Linear term
tidycmprsk::crr(Surv(PFS,cum_prog)~PSA_Nadir12 + PSA_trt_gap12 + csskull + csspine + Gleason.total + denovomet_disease + age + alkcat, data = dta_baseline_pfs, failcode = "progression")

###With categorical time to PSA nadir interval

tidycmprsk::crr(Surv(PFS, cum_prog)~PSA_Nadir12 + PSA_gap1 + csskull + csspine + Gleason.total +  denovomet_disease + age + alkcat, data = dta_baseline_pfs, failcode = "progression")

```

## PFS analysis
```{r}
dta_baseline_pfs%>%
  filter(any_progression==1)%>%
  select(PCSM)%>%
  table()

### After progression, 83 were alive, 72 had PCSM, 20 died of other causes. 

survfit(Surv(PFS,progression==1)~PSA_Nadir12, data = dta_baseline_pfs)

survfit(Surv(PFS,progression==1)~PSA_Nadir12, data = dta_baseline_pfs)%>%
  summary(., times = 36)

### Logrank test (overall and pairwise comparisons)
survdiff(Surv(PFS,progression==1)~PSA_Nadir12, data = dta_baseline_pfs)

pairwise_survdiff(Surv(PFS,progression==1)~PSA_Nadir12, data = dta_baseline_pfs, p.adjust.method = "bonferroni")

### Survival curves by PSA nadir
survfit2(Surv(PFS,progression==1)~PSA_Nadir12, data = dta_baseline_pfs)%>%
  ggsurvfit(linetype_aes = T, linewidth = 1) + 
  add_censor_mark() + 
  add_confidence_interval() + 
  add_risktable() + 
  scale_ggsurvfit(x_scales = list(breaks = seq(0,48, by = 12)), y_scales = list(breaks = seq(0,1, by = 0.2))) + labs(x = "Time since landmark timepoint (in months)", y = "Progression-free survival probability") + 
  theme_bw()

######################################################################
### Without time interval to PSA nadir
cox_pfs <- coxph(Surv(PFS,progression==1)~PSA_Nadir12 + csskull + Gleason.total + denovomet_disease + age + csspine + alkcat, data = dta_baseline_pfs, x = T, y = T)
summary(cox_pfs)

cox.zph(cox_pfs) 

#### Time to PSA Nadir fitted with natural spline with 4 degrees of freedom in patients with baseline PSA
cox_pfs1_spline <- coxph(Surv(PFS,progression==1)~PSA_Nadir12 + ns(PSA_trt_gap12, 4) + csskull + Gleason.total + denovomet_disease + age + alkcat + csspine, data = dta_baseline_pfs, x = T, y = T)

summary(cox_pfs1_spline)

cox.zph(cox_pfs1_spline) 

termplot(cox_pfs1_spline, terms = 2, se = TRUE, rug = TRUE, xlabs = "Time interval to PSA nadir", ylabs = "Partial hazard ratio for PFS") ###Slight non-linearity. I would go with the prior model for easier interpretability. 

cox_pfs1_linear <- coxph(Surv(PFS,progression==1)~PSA_Nadir12 + PSA_trt_gap12 + csskull + Gleason.total + denovomet_disease + age + alkcat + csspine, data = dta_baseline_pfs, x = T, y = T)

summary(cox_pfs1_linear)

cox.zph(cox_pfs1_linear) 

########### Time to PSA nadir as categorical variable
cox_pfs12 <- coxph(Surv(PFS,progression==1)~PSA_Nadir12 + PSA_gap1 + csskull + Gleason.total + denovomet_disease + age + alkcat + csspine, data = dta_baseline_pfs, x = T, y = T)

summary(cox_pfs12)

cox.zph(cox_pfs12) 

######################## Parametric survival models
### To account for violation of proportionality assumption in the model without time to PSA nadir #############
# Load necessary library
# Define the formula
surv_formula <- Surv(PFS, progression == 1) ~ PSA_Nadir12 + csskull + Gleason.total + denovomet_disease + age + csspine + alkcat

# List of distributions to test
dist_list <- c("weibull", "lognormal", "loglogistic", "exponential", "gompertz")

# Initialize an empty list to store the results
model_list <- list()
aic_list <- numeric(length(dist_list))

# Loop through each distribution and fit the survival model
for (i in seq_along(dist_list)) {
  dist <- dist_list[i]
  if (dist == "gompertz") {
    # Gompertz is not directly available in survreg, so use flexsurv
    model <- flexsurv::flexsurvreg(surv_formula, data = dta_baseline, dist = "gompertz")
    aic_value <- model$AIC
  } else {
    # Fit the model using survreg for other distributions
    model <- survreg(surv_formula, data = dta_baseline_pfs, dist = dist)
    aic_value <- AIC(model)
  }
  
  # Store model and AIC
  model_list[[dist]] <- model
  aic_list[i] <- aic_value
}

# Create a data frame with AIC values for comparison
aic_results <- data.frame(
  Distribution = dist_list,
  AIC = aic_list
)

# Find the best distribution based on the lowest AIC
best_model_index <- which.min(aic_results$AIC)
best_model <- model_list[[dist_list[best_model_index]]]

# Print AIC results and best model
print(aic_results)

cat("Best model distribution:", dist_list[best_model_index], "\n")

summary(best_model)


```

## Those who were excluded from and those who were included in the landmark analysis 
```{r}
dta_baseline_notincl <- cohort2.1%>%
  filter(!subject %in% dta_baseline$subject)

explan <- c("age","baseline_psa","baseline_psa_cat","alkcat","csliver","cslung","csdn","csskull","csspine","denovomet_disease","treatment","Gleason.total","PSA_Nadir6","baseline_alkval")

dta_baseline_notincl%>%
  summary_factorlist(explanatory = explan,
                     dependent = "PSA_Nadir12",
                     cont = "median",
                     p_cat = "chisq",
                     na_include = T,
                     add_col_totals = T,
                     p = T) ->t1.5

dta_baseline_notincl%>%select(Dead)%>%table()

dta_baseline_notincl%>%select(PCSM, any_progression)%>%table()

dta_baseline_notincl%>%
  group_by(PSA_Nadir12)%>%
  select(PCSM)%>%
  table()

dta_baseline_notincl%>%
  group_by(PSA_Nadir12)%>%
  select(PCSM)%>%table()%>%
  prop.table(margin = 1)

dta_baseline_notincl%>%
  group_by(PSA_Nadir12)%>%
  select(cum_prog)%>%
  table()

dta_baseline_notincl%>%
  group_by(PSA_Nadir12)%>%
  select(cum_prog)%>%
  table()%>%
  prop.table(margin = 1)

dta_baseline_notincl%>%
  group_by(PSA_Nadir12)%>%
  select(any_progression)%>%
  table()

dta_baseline_notincl%>%
  group_by(PSA_Nadir12)%>%
  select(any_progression)%>%
  table()%>%
  prop.table(margin = 1)

#####################################
dta_complete_notincl <- dta_baseline_notincl%>%
  select(baseline_psa, baseline_alkval, age, Nadir_value12)%>%
  drop_na()

corr_matrix <- cor(dta_complete_notincl[, sapply(dta_complete_notincl, is.numeric)])
corrplot::corrplot(corr_matrix, method = "circle", type = "upper", order = "hclust")

###########################################
library(GGally)

ggpairs(dta_complete_notincl[, sapply(dta_complete_notincl, is.numeric)])

####################################################################################################
dta_baseline%>%
  summary_factorlist(explanatory = explan,
                     dependent = "PSA_Nadir12",
                     cont = "median",
                     p_cat = "chisq",
                     na_include = T,
                     add_col_totals = T,
                     p = T) ->t1.6

knitr::kable(t1.6)

#####################################
dta_complete <- dta_baseline%>%
  select(baseline_psa, baseline_alkval, age, Nadir_value12)%>%
  drop_na()

corr_matrix <- cor(dta_complete[, sapply(dta_complete, is.numeric)])
corrplot::corrplot(corr_matrix, method = "circle", type = "upper", order = "hclust")

###########################################
library(GGally)

ggpairs(dta_complete[, sapply(dta_complete, is.numeric)])

```

## Non-landmark analysis with time to PSA nadir and PSA nadir level integrated
```{r}
library(smoothHR)
library(Hmisc)
library(rms)
library(mgcv)

cohort2.1 <- cohort2.1%>%
  mutate(PSA_gap1 = ifelse(PSA_trt_gap12<=3,"<=3",
                           ifelse(PSA_trt_gap12>3 & PSA_trt_gap12<=6,">3-6",">6")))



#### Cox model with natural splines of time interval to PSA nadir with 4 degrees of freedom and outcome
hr1 <- coxph(Surv(OS,Dead==1)~PSA_Nadir12 + ns(PSA_trt_gap12, 4) + csskull + Gleason.total + alkcat + denovomet_disease + age, data = cohort2.1, x = T, y = T)

termplot(hr1, term = 2, col.term = 2, col.se = 2, se=TRUE, plot=T, xlab = "Time interval to PSA nadir", ylab = "Partial hazard ratio for time interval to PSA nadir")

summary(hr1)

cox.zph(hr1)

### Heller's ERR
clinfun::coxphERR(hr1, 1) 

clinfun::coxphERR(hr1, 2) 

clinfun::coxphERR(hr1, 3)

clinfun::coxphERR(hr1, 4) 

clinfun::coxphERR(hr1, 5) 

clinfun::coxphERR(hr1, 6) 

clinfun::coxphERR(hr1, 7) 

clinfun::coxphERR(hr1, 8) 

########### With categorical time interval to PSA nadir
hr21 <- coxph(Surv(OS,Dead==1)~PSA_Nadir12 + PSA_gap1 + csskull + Gleason.total + alkcat + denovomet_disease + age, data = cohort2.1, x = T, y = T)

cox.zph(hr21)

summary(hr21)

######################################### Linear fit of time to PSA nadir
coxph(Surv(OS,Dead==1)~PSA_Nadir12 + PSA_trt_gap12 + csskull + Gleason.total + alkcat + denovomet_disease + age, data = cohort2.1, x = T, y = T)%>%summary()

coxph(Surv(OS,Dead==1)~PSA_Nadir12 + PSA_trt_gap12 + csskull + Gleason.total + alkcat + denovomet_disease + age, data = cohort2.1, x = T, y = T)%>%cox.zph()

####################################################################################################### We will be more simplistic
### Multivariable Cox regression with PSA nadir levels and without time to PSA nadir
hr2 <- coxph(Surv(OS,Dead==1)~PSA_Nadir12 + csskull + Gleason.total + denovomet_disease + age + alkcat, data = cohort2.1, x = T, y = T)

cox.zph(hr2)

summary(hr2)

#######################################################################################################
### Competing risk regression with PSA nadir level 

cohort2.1$PCSM = factor(cohort2.1$PCSM, levels = c("Alive","PCSM","OCM"))

tidycmprsk::crr(Surv(OS,PCSM)~PSA_Nadir12 + csskull + Gleason.total + denovomet_disease + age + alkcat + denovomet_disease, data = cohort2.1, failcode = "PCSM")

### Competing risk regression with PSA nadir level and time to PSA nadir with natural spline and linear term
tidycmprsk::crr(Surv(OS,PCSM)~PSA_Nadir12 + ns(PSA_trt_gap12, 4) + csskull + Gleason.total + alkcat + denovomet_disease + age, data = cohort2.1, failcode = "PCSM")

tidycmprsk::crr(Surv(OS,PCSM)~PSA_Nadir12 + PSA_trt_gap12 + csskull + Gleason.total + alkcat + denovomet_disease + age, data = cohort2.1, failcode = "PCSM")

###Now given the non_linear association, we would convert PSA gap to a categorical variable. 

tidycmprsk::crr(Surv(OS,PCSM)~PSA_Nadir12 + PSA_gap1 + csskull + Gleason.total + alkcat + denovomet_disease + age, data = cohort2.1, failcode = "PCSM")

################################################################################################
#########33Competing risk regression with just PSA nadir level 
tidycmprsk::crr(Surv(PFS,cum_prog)~PSA_Nadir12 + csskull + csspine + Gleason.total + denovomet_disease + age + alkcat, data = cohort2.1, failcode = "progression")

######################## Competing risk regression with PSA nadir level and time to PSA nadir with spline and linear term
tidycmprsk::crr(Surv(PFS,cum_prog)~PSA_Nadir12 + ns(PSA_trt_gap12, 4) + csskull + csspine + Gleason.total + denovomet_disease + age + alkcat, data = cohort2.1, failcode = "progression")

tidycmprsk::crr(Surv(PFS,cum_prog)~PSA_Nadir12 + PSA_trt_gap12 + csskull + csspine + Gleason.total + denovomet_disease + age + alkcat, data = cohort2.1, failcode = "progression")

###With categorical time to PSA nadir interval

tidycmprsk::crr(Surv(PFS, cum_prog)~PSA_Nadir12 + PSA_gap1 + csskull + Gleason.total + denovomet_disease + age + csspine + alkcat, data = cohort2.1, failcode = "progression")

```

## Standard OS and Fine and Gray PCSM analysis in this non-landmark cohort
```{r}
### Simple survival analysis
survival_nadir <- survfit(Surv(OS,Dead==1)~PSA_Nadir12, data = cohort2.1)
### Survival at 3 years
summary(survival_nadir, times = 36)

### Logrank test (overall and pairwise comparisons)
survdiff(Surv(OS,Dead==1)~PSA_Nadir12, data = cohort2.1)

pairwise_survdiff(Surv(OS,Dead==1)~PSA_Nadir12, data = cohort2.1, p.adjust.method = "bonferroni")

### Survival curves by PSA nadir
survfit2(Surv(OS,Dead==1)~PSA_Nadir12, data = cohort2.1)%>%
  ggsurvfit(linetype_aes = T, linewidth = 1) + 
  add_censor_mark() + 
  add_confidence_interval() + 
  add_risktable() + 
  scale_ggsurvfit(x_scales = list(breaks = seq(0,48, by = 12)), y_scales = list(breaks = seq(0,1, by = 0.2))) + theme_bw() + labs(legend.title = "PSA Nadir", x = "Time since landmark timepoint (months)", y = "Overall survival probability")

###########################################################################################

tidycmprsk::cuminc(Surv(OS,PCSM)~PSA_Nadir12, data = cohort2.1)%>%
  tidycmprsk::tbl_cuminc(times = c(24,36, 48), label_header = "**Month {time}**")%>%
  add_p()%>%
  add_n()

cuminc(Surv(OS, PCSM) ~ PSA_Nadir12, data = cohort2.1) %>%
  ggcuminc(outcome = "PCSM") +
  add_confidence_interval() +
  add_risktable() +
  scale_x_continuous(limits = c(0,48), breaks = c(0,12,24,36,48)) + 
  scale_y_continuous(limits = c(0,1), n.breaks = 5)+ 
  labs(x = "Time since landmark timepoint (months)", y = "Cumulative incidence of CSM")

########################################################################
tidycmprsk::cuminc(Surv(PFS,cum_prog)~PSA_Nadir12, data = dta_baseline)%>%
  tidycmprsk::tbl_cuminc(times = c(24,36, 48), label_header = "**Month {time}**")%>%
  add_p()%>%
  add_n()

cuminc(Surv(PFS,cum_prog) ~ PSA_Nadir12, data = dta_baseline) %>%
  ggcuminc(outcome = "progression") +
  add_confidence_interval() +
  add_risktable() +
  scale_x_continuous(limits = c(0,48), breaks = c(0,12,24,36,48)) + 
  scale_y_continuous(limits = c(0,1), n.breaks = 5) + 
  labs(x = "Time since landmark timepoint (months)", y = "Cumulative incidence of progression")

###############################################################################3
### Simple survival analysis
survival_nadir <- survfit(Surv(PFS,progression==1)~PSA_Nadir12, data = cohort2.1)
### Survival at 3 years
summary(survival_nadir, times = 36)

### Logrank test (overall and pairwise comparisons)
survdiff(Surv(PFS,progression==1)~PSA_Nadir12, data = cohort2.1)

pairwise_survdiff(Surv(PFS,progression==1)~PSA_Nadir12, data = cohort2.1, p.adjust.method = "bonferroni")

### Survival curves by PSA nadir
survfit2(Surv(PFS,progression==1)~PSA_Nadir12, data = cohort2.1)%>%
  ggsurvfit(linetype_aes = T, linewidth = 1) + 
  add_censor_mark() + 
  add_confidence_interval() + 
  add_risktable() + 
  scale_ggsurvfit(x_scales = list(breaks = seq(0,48, by = 12)), y_scales = list(breaks = seq(0,1, by = 0.2))) + theme_bw() + labs(legend.title = "PSA Nadir", x = "Time since landmark timepoint (months)", y = "Progression-free survival probability")


```

## Forest plot in the full cohort with available baseline PSA data - for OS and PFS without time to PSA nadir by 12 months
```{r}
library(rms)
f <- cph(Surv(OS,Dead==1)~PSA_Nadir12 + csskull + Gleason.total + alkcat + denovomet_disease + age + PSA_Nadir6, data = cohort2.1, x = T, y = T)

anova_f <- anova(f)

label_map <- c("csskull" = "Skull involvement", 
               "baseline_psa" = "Baseline PSA",
               "denovomet_disease" = "Denovo Metastatic Disease", 
               "PSA_Nadir6" = "PSA Nadir at 6 Months", 
               "alkcat" = "Baseline ALP", 
               "Gleason.total" = "Gleason Score",
               "age" = "Age", 
               "PSA_Nadir12" = "PSA Nadir at 12 Months")

# Modify the plot labels using the 'las' argument and apply the label map
plot(anova_f, what = 'proportion chisq', 
     labels = label_map[rownames(anova_f)], las = 2) 

### For progression-free survival
f1 <- cph(Surv(PFS,progression==1)~PSA_Nadir12 + csskull + Gleason.total + alkcat + denovomet_disease + age + PSA_Nadir6 + csspine, data = cohort2.1, x = T, y = T)

anova_f1 <- anova(f1)

# Create a named vector with the new labels
label_map <- c("csskull" = "Skull involvement", 
               "baseline_psa" = "Baseline PSA",
               "denovomet_disease" = "Denovo Metastatic Disease", 
               "PSA_Nadir6" = "PSA Nadir at 6 Months", 
               "alkcat" = "Baseline ALP", 
               "Gleason.total" = "Gleason Score",
               "age" = "Age", 
               "PSA_Nadir12" = "PSA Nadir at 12 Months", 
               "csspine" = "Clinical Spine Involvement")

# Modify the plot labels using the 'las' argument and apply the label map
plot(anova_f1, what = 'proportion chisq', 
     labels = label_map[rownames(anova_f1)], las = 2) 

```


## Forest plot in the full cohort with available baseline PSA data - for OS and PFS with time to PSA nadir by 12 months
```{r}
### For overall survival
library(rms)
f2 <- cph(Surv(OS,Dead==1)~PSA_Nadir12 + PSA_trt_gap12 + csskull + Gleason.total + alkcat + denovomet_disease + age + PSA_Nadir6, data = cohort2.1, x = T, y = T)

anova_f2 <- anova(f2)

label_map <- c("csskull" = "Skull involvement", 
               "baseline_psa" = "Baseline PSA",
               "denovomet_disease" = "Denovo Metastatic Disease", 
               "PSA_Nadir6" = "PSA Nadir at 6 Months", 
               "alkcat" = "Baseline ALP", 
               "Gleason.total" = "Gleason Score",
               "age" = "Age", 
               "PSA_Nadir12" = "PSA Nadir at 12 Months", 
               "PSA_trt_gap12" = "Time interval to PSA Nadir")

# Modify the plot labels using the 'las' argument and apply the label map
plot(anova_f2, what = 'proportion chisq', 
     labels = label_map[rownames(anova_f2)], las = 2) 

### For progression-free survival
f11 <- cph(Surv(OS,Dead==1)~PSA_Nadir12 + PSA_trt_gap12 + csskull + Gleason.total + alkcat + denovomet_disease + age + PSA_Nadir6 + csspine, data = cohort2.1, x = T, y = T)

anova_f11 <- anova(f11)

# Create a named vector with the new labels
label_map <- c("csskull" = "Skull involvement", 
               "baseline_psa" = "Baseline PSA",
               "denovomet_disease" = "Denovo Metastatic Disease", 
               "PSA_Nadir6" = "PSA Nadir at 6 Months", 
               "alkcat" = "Baseline ALP", 
               "Gleason.total" = "Gleason Score",
               "age" = "Age", 
               "PSA_Nadir12" = "PSA Nadir at 12 Months", 
               "PSA_trt_gap12" = "Time interval to PSA Nadir", 
               "csspine" = "Clinical Spine Involvement")

# Modify the plot labels using the 'las' argument and apply the label map
plot(anova_f11, what = 'proportion chisq', 
     labels = label_map[rownames(anova_f11)], las = 2) 

```


```{r}
save(cohort2.1, file=here("data", "soum_cohort.rdata"))

```

