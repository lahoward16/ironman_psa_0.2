---
title: 'IRONMAN: PSA <0.2 ng/ml after ARPI'
author: "Lauren Howard & Kerri-Anne Crowell"
date: "`r Sys.Date()`"
output: html_document
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0("../Results/IRONMAN PSA 0.2 analysis ",Sys.Date(),'.html')) })

---

```{r, echo =FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning=FALSE, 
                      message=FALSE, 
                      tidy=TRUE,
                      fig.align='center',
                      fig.show='hold',
                      size='footnotesize',
                      fig.width=10,
                      fig.height=6)
```


```{r}
# load packages
library(readxl)
library(tidyverse)
library(lubridate)
library(here)
library(dplyr)
library(labelled)
library(writexl)
library(DT)
library(gtsummary)
library(ggsurvfit)
library(consort)

```

```{r}
# Read data
load(here("data", paste0("ironman_psa0.2_20250507.RData")))
     
```

# Consort diagram

```{r}
consort_data <- all_data2 %>% 
  mutate(exclusion0 = case_when(
    is.na(dt_lot_start1) ~ "Missing treatment data",
    year==2025 ~ "Treatment started in 2025"
  ),
    exclusion1 = case_when(
    cohort_std=="CRPC" ~ "CRPC",
    is.na(cohort_std) ~ "Missing disease state",
    TRUE ~ NA),
    exclusion2 = case_when(
      cohort_std=="CRPC" ~ NA,
      tmt_regimen=="ADT monotherapy" ~ "ADT monotherapy",
      tmt_regimen=="ADT + docetaxel" ~ "ADT + docetaxel",
      tmt_regimen=="Other" ~ "Other treatment",
      is.na(tmt_regimen) ~ "Missing treatment information", 
      grepl("ARPI", tmt_regimen) & adt=="No" ~ "ARPI but no documented ADT"),
    exclusion3 = case_when(
      is.na(psa_nadir6) ~ "Missing follow-up PSA"
      #is.na(pre_tmt_psa) ~ "Missing pre-treatment PSA"
    ))
 
out <- consort_plot(data = consort_data,
                    orders = c(subject = "IRONMAN cohort",
                               exclusion0 = "Exclude",
                               subject = "Treatment started 2017-2024",
                               exclusion1 = "Exclude",
                               subject = "mHSPC",
                               exclusion2 = "Exclude treatments",
                               subject = "Treated with documented ADT + ARPI",
                               exclusion3 = "Exclude missing PSA",
                               subject = "Study cohort"),
                    side_box = c("exclusion0", "exclusion1", "exclusion2", "exclusion3"),
                    cex = 0.9)
plot(out)

# cohort for analysis
cohort <- consort_data %>% 
  filter(is.na(exclusion0) & is.na(exclusion1) & is.na(exclusion2) & is.na(exclusion3))  
 

```



# Comparing Soum's and my cohort

```{r, echo = FALSE}
mydata <- consort_data %>% 
  # filter(is.na(exclusion1) & is.na(exclusion2)) # require documented ADT 
  filter(cohort_std=="mHSPC" & grepl("ARPI", tmt_regimen)) # do not require documented AD

load(here("data", "soum_cohort.rdata"))

inboth <- length(intersect(mydata$subject, cohort2.1$subject)) # 1083 / 1375
# Only in mine
inmine <- setdiff(mydata$subject, cohort2.1$subject) # 74 / 106
# Only in Soum's
insoum <- setdiff(cohort2.1$subject, mydata$subject) # 318 / 26

# only in mine:
# seems that these patients have spaced out start date for ADT and ARPI

# only in Soums:
# 170-01-033: ADT + ARPI + carboplatin (start on the same day)
# 170-02-096: ARPI + Pembro RCT
# 170-02-100: ADT + ARPI + Pembro RCT
# 170-105-019: ADT + ARPI + Pembro RCT
# Looks like these patients are on a clinical trial or another drug with ADT + ARPI

```
I ran Soum's provided code on our version of the data to compare his cohort who received ARPI to the cohort generated by my code. His code did not require documented ADT so I did the same here with my code. His cohort has `r nrow(cohort2.1)` patients who received ARPI before other exclusions and mine had `r nrow(mydata)`. There were `r inboth` overlapping patients. His code was missing `r length(inmine)` patients that were in my cohort. It seems that he missed some patients who had intensification within 90 days. There were `r length(insoum)` patients in Soum's dataset that were missing from mine. Looking into these patients, many of them were on clinical trials and received another drug along with ADT + ARPI such as pembro/placebo.

# Baseline characteristics 
## Stratified by PSA nadir with 6 months
```{r}
# remove comma from numbers
theme_gtsummary_language("en", big.mark = "")

cohort %>% 
  mutate(tmt_regimen = droplevels(tmt_regimen),
         site_country_gp = fct_lump_prop(site_country, 0.05)) %>% 
  set_variable_labels(tmt_regimen = "Treatment regimen",
                      site_country_gp = "Country") %>% 
  select(psa_nadir6gp, age, year, tmt_regimen, arpi_drug, psa_nadir6,
         pre_tmt_psa20, alk150, racegp, met_combo4, met_liver, met_lung, 
         gleason_combined_derived,
         t_stage_gp, n_stage_gp, denovomet_disease, diag_tmt_start, rp_xrt,
         site_country_gp) %>% 
  tbl_summary(by=psa_nadir6gp,
              digits = list(psa_nadir6 ~ 2, year ~ 0),
              type = year ~ "continuous") %>% 
  add_overall() %>% 
  bold_labels()

# consort_data %>% 
#   filter(is.na(exclusion1) & is.na(exclusion2)) %>% 
#   mutate(tmt_regimen = droplevels(tmt_regimen)) %>% 
#   set_variable_labels(tmt_regimen = "Treatment regimen") %>% 
#   select(psa_nadir6gp, age, tmt_regimen, denovomet_disease, psa_nadir6,
#          pre_tmt_psa20, alk150, racegp, met_combo4, gleason_combined_derived) %>% 
#   tbl_summary(digits = list(psa_nadir6 ~ 2)) %>% 
#   bold_labels()
```

## Stratified by PSA nadir with 12 months
```{r}
# remove comma from numbers
theme_gtsummary_language("en", big.mark = "")

cohort %>% 
  mutate(tmt_regimen = droplevels(tmt_regimen),
         site_country_gp = fct_lump_prop(site_country, 0.05)) %>% 
  set_variable_labels(tmt_regimen = "Treatment regimen",
                      site_country_gp = "Country") %>% 
  select(psa_nadir12gp, age, year, tmt_regimen, arpi_drug, psa_nadir12,
         pre_tmt_psa20, alk150, racegp, met_combo4, , met_liver, met_lung,
         gleason_combined_derived,
         t_stage_gp, n_stage_gp, denovomet_disease, diag_tmt_start, rp_xrt,
         site_country_gp) %>% 
  tbl_summary(by=psa_nadir12gp,
              digits = list(psa_nadir12 ~ 2, year ~ 0),
              type = year ~ "continuous") %>% 
  add_overall() %>% 
  bold_labels()

```


